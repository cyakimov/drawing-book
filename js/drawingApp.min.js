!function(){var CanvasHandler,DrawingApp;DrawingApp=function(){function DrawingApp(opts){var defaults;this.opts=opts,defaults={renderTo:".drawing-book",pages:null,canvasWidth:null,canvasHeight:null},this.animatingPage=!1,this.pages=[],this.imagesToLoad=0,this.currPageNum=0,this.options=$.extend(defaults,opts),this.book=$(this.options.renderTo),this.preloadImages(),$(function(){return new FastClick(document.body)})}return DrawingApp.prototype.createBook=function(){var colors,first,i,newPage,p,page,_base,_base1,_i,_len,_ref;for(null==(_base=this.options).canvasWidth&&(_base.canvasWidth=$(window).width()),null==(_base1=this.options).canvasHeight&&(_base1.canvasHeight=$(window).height()),this.book.css({width:this.options.canvasWidth,height:this.options.canvasHeight}),this.options.pages.length>1&&this.setupPageControls(),first=!0,i=0,_ref=this.options.pages,_i=0,_len=_ref.length;_len>_i;_i++)p=_ref[_i],p.background||(p.background={color:"#fff"}),p.background.color||p.background.image||(p.background={color:"#fff"}),page=this.createPage(i++,first,p.background),newPage=new CanvasHandler({canvas:page.find(".sketch"),bgCanvas:page.find(".bg-sketch"),brushImage:null,bgImage:p.outlineImage.img,canvasWidth:this.options.canvasWidth,canvasHeight:this.options.canvasHeight}),this.pages.push(newPage),first=!1;return colors=this.book.find(".colors").css("display","block"),colors.find("a").bind("click",$.proxy(this.onColorChange,this)),colors.find("a.active").trigger("click")},DrawingApp.prototype.preloadImages=function(){var bg,color,colors,img,p,_i,_j,_len,_len1,_ref,_results;for(colors=$(this.options.renderTo).find(".colors a"),_i=0,_len=colors.length;_len>_i;_i++)color=colors[_i],void 0!==$(color).data("brush")&&(this.imagesToLoad++,img=new Image,img.onload=$.proxy(this.onImageLoaded,this),img.src=$(color).data("brush"));for(_ref=this.options.pages,_results=[],_j=0,_len1=_ref.length;_len1>_j;_j++)p=_ref[_j],this.imagesToLoad++,bg=new Image,p.outlineImage.img=bg,bg.onload=$.proxy(this.onImageLoaded,this),_results.push(bg.src=p.outlineImage.path);return _results},DrawingApp.prototype.onImageLoaded=function(){var _this=this;return this.imagesToLoad--,this.imagesToLoad<=0?$(function(){return _this.createBook()}):void 0},DrawingApp.prototype.createPage=function(pageNum,active,background){var backgroundStyle,marginLeft,page,pageHTML,_class;return _class=active===!0?"active":"inactive",_class+=" js-page-"+pageNum,background=void 0!==background.color?background.color:"transparent",background=void 0!==background.image?" url("+background.image+");":";",backgroundStyle='style="background: '+background+'"',pageHTML='            <div data-num="'+pageNum+'" '+backgroundStyle+' class="page animated '+_class+'">                <canvas width="'+this.options.canvasWidth+'" height="'+this.options.canvasHeight+'" class="sketch" ></canvas>                <canvas width="'+this.options.canvasWidth+'" height="'+this.options.canvasHeight+'" class="bg-sketch" ></canvas>            </div>',page=$(pageHTML),$(this.options.renderTo).append(page),marginLeft=active?-(this.options.canvasWidth/2):2*-this.options.canvasWidth,page.css({width:this.options.canvasWidth,height:this.options.canvasHeight,marginLeft:marginLeft,marginTop:-(this.options.canvasHeight/2),left:"50%",top:"50%"})},DrawingApp.prototype.onColorChange=function(e){var button,p,_i,_len,_ref,_results;if(e.preventDefault(),button=$(e.currentTarget),button.hasClass("reset"))return this.pages[this.currPageNum].clear();for($(this.options.renderTo).find(".colors a.active").removeClass("active"),button.addClass("active"),_ref=this.pages,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)p=_ref[_i],_results.push(p.setBrushColor(button));return _results},DrawingApp.prototype.setupPageControls=function(){var _this=this;return $(this.options.renderTo).find(".paginator").show().find("a").bind("click",function(e){var button,currPage,img,next,nextArrow,prev,prevArrow;return e.preventDefault(),_this.animatingPage||(_this.animatingPage=!0,button=$(e.currentTarget),""===button.attr("disabled"))?void 0:(currPage=$(_this.options.renderTo).find(".page.active"),img=button.find("img"),_this.currPageNum=parseInt(currPage.data("num")),button.hasClass("js-left")?(nextArrow=button.next().find("img"),nextArrow.attr("src",nextArrow.data("img-enabled")),prev=$(_this.options.renderTo).find(".js-page-"+(_this.currPageNum-1)),currPage.addClass("fadeOutRightBig").removeClass("active"),prev.addClass("fadeInLeftBig active").removeClass("inactive").css("marginLeft",-_this.options.canvasWidth/2),setTimeout(function(){return _this.clearPage(currPage)},1e3),0===$(_this.options.renderTo).find(".js-page-"+(_this.currPageNum-2)).length?(button.attr("disabled",""),img.attr("src",img.data("img-disabled"))):(button.removeAttr("disabled"),img.attr("src",img.data("img-enabled"))),img=$("a.js-right").removeAttr("disabled").find("img"),img.attr("src",img.data("image-enabled")),_this.currPageNum--):(prevArrow=button.prev().find("img"),prevArrow.attr("src",prevArrow.data("img-enabled")),next=$(_this.options.renderTo).find(".js-page-"+(_this.currPageNum+1)),currPage.addClass("fadeOutLeftBig").removeClass("active"),next.addClass("fadeInRightBig active").removeClass("inactive").css("marginLeft",-_this.options.canvasWidth/2),setTimeout(function(){return _this.clearPage(currPage)},1e3),0===$(_this.options.renderTo).find(".js-page-"+(_this.currPageNum+2)).length&&(button.attr("disabled",""),img.attr("src",img.data("img-disabled"))),img=$(_this.options.renderTo).find("a.js-left").removeAttr("disabled").find("img"),img.attr("src",img.data("image-enabled")),_this.currPageNum++))})},DrawingApp.prototype.clearPage=function(page){return page.removeClass("fadeInRightBig fadeInLeftBig fadeOutLeftBig fadeOutRightBig").css("marginLeft",2*-this.options.canvasWidth),this.animatingPage=!1},DrawingApp}(),window.drawingApp=function(params){return new DrawingApp(params)},CanvasHandler=function(){function CanvasHandler(opts){this.renderFunction=opts.brushImage?this.updateCanvasByBrush:this.updateCanvasByLine,this.brush=opts.brushImage,this.touchSupported=Modernizr.touch,this.canvas=opts.canvas,this.context=this.canvas.get(0).getContext("2d"),this.context.strokeStyle="#000000",this.context.lineWidth=3,this.lastMousePoint={x:0,y:0},this.touchSupported?(this.mouseDownEvent="touchstart",this.mouseMoveEvent="touchmove",this.mouseUpEvent="touchend"):(this.mouseDownEvent="mousedown",this.mouseMoveEvent="mousemove",this.mouseUpEvent="mouseup"),opts.bgCanvas&&opts.bgImage&&(this.bgCanvas=opts.bgCanvas,this.bgContext=this.bgCanvas.get(0).getContext("2d"),this.bgContext.drawImage(opts.bgImage,(opts.canvasWidth-opts.bgImage.width)/2,(opts.canvasHeight-opts.bgImage.height)/2),this.bgCanvas.bind(this.mouseDownEvent,this.onCanvasMouseDown()))}return CanvasHandler.prototype.setBrushColor=function(button){var brushImage;return button.hasClass("eraser")?(this.renderFunction=this.updateCanvasByLine,this.context.lineWidth=30,this.context.globalCompositeOperation="destination-out",this.context.strokeStyle="rgba(0,0,0,1)",void 0):(this.context.globalCompositeOperation="source-over",null!==button.data("brush")?(brushImage=new Image,brushImage.src=button.data("brush"),this.renderFunction=this.updateCanvasByBrush,this.brush=brushImage):this.context.strokeStyle=button.css("background-color"))},CanvasHandler.prototype.onCanvasMouseDown=function(){var _this=this;return function(event){return _this.mouseMoveHandler=_this.onCanvasMouseMove(),_this.mouseUpHandler=_this.onCanvasMouseUp(),$(document).bind(_this.mouseMoveEvent,_this.mouseMoveHandler),$(document).bind(_this.mouseUpEvent,_this.mouseUpHandler),_this.updateMousePosition(event),_this.renderFunction(event)}},CanvasHandler.prototype.onCanvasMouseMove=function(){var _this=this;return function(event){return _this.renderFunction(event),event.preventDefault(),!1}},CanvasHandler.prototype.onCanvasMouseUp=function(){var _this=this;return function(){return $(document).unbind(_this.mouseMoveEvent,_this.mouseMoveHandler),$(document).unbind(_this.mouseUpEvent,_this.mouseUpHandler),_this.mouseMoveHandler=null,_this.mouseUpHandler=null}},CanvasHandler.prototype.updateMousePosition=function(event){var offset,target;return target=this.touchSupported?event.targetTouches[0]:event,offset=this.canvas.offset(),this.lastMousePoint.x=target.pageX-offset.left,this.lastMousePoint.y=target.pageY-offset.top},CanvasHandler.prototype.updateCanvasByLine=function(event){return this.context.beginPath(),this.context.moveTo(this.lastMousePoint.x,this.lastMousePoint.y),this.updateMousePosition(event),this.context.lineTo(this.lastMousePoint.x,this.lastMousePoint.y),this.context.stroke()},CanvasHandler.prototype.updateCanvasByBrush=function(event){var angle,distance,end,halfBrushH,halfBrushW,start,x,y,z,_results;for(halfBrushW=this.brush.width/2,halfBrushH=this.brush.height/2,start={x:this.lastMousePoint.x,y:this.lastMousePoint.y},this.updateMousePosition(event),end={x:this.lastMousePoint.x,y:this.lastMousePoint.y},distance=parseInt(this.distanceBetween2Points(start,end)),angle=this.angleBetween2Points(start,end),x=void 0,y=void 0,z=0,_results=[];distance>=z||0===z;)x=start.x+Math.sin(angle)*z-halfBrushW,y=start.y+Math.cos(angle)*z-halfBrushH,this.context.drawImage(this.brush,x,y),_results.push(z++);return _results},CanvasHandler.prototype.updateMousePosition=function(event){var offset,target;return target=this.touchSupported?event.targetTouches[0]:event,offset=this.canvas.offset(),this.lastMousePoint.x=target.pageX-offset.left,this.lastMousePoint.y=target.pageY-offset.top},CanvasHandler.prototype.clear=function(){var c;return c=this.canvas[0],this.context.clearRect(0,0,c.width,c.height)},CanvasHandler.prototype.distanceBetween2Points=function(point1,point2){var dx,dy;return dx=point2.x-point1.x,dy=point2.y-point1.y,Math.sqrt(Math.pow(dx,2)+Math.pow(dy,2))},CanvasHandler.prototype.angleBetween2Points=function(point1,point2){var dx,dy;return dx=point2.x-point1.x,dy=point2.y-point1.y,Math.atan2(dx,dy)},CanvasHandler}()}.call(this);