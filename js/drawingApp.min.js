(function(){var k,f=function(a){this.opts=a;this.animatingPage=!1;this.pages=[];this.currPageNum=this.imagesToLoad=0;this.options=$.extend({renderTo:".drawing-book",pages:null,canvasWidth:1024,canvasHeight:768},a);this.book=$(this.options.renderTo);this.preloadImages();$(function(){return new FastClick(document.body)})};f.prototype.createBook=function(){var a,b,c,d,e,h;this.book.css({width:this.options.canvasWidth,height:this.options.canvasHeight});1<this.options.pages.length&&this.setupPageControls();
b=!0;a=0;h=this.options.pages;d=0;for(e=h.length;d<e;d++)c=h[d],c.background||(c.background={color:"#fff"}),!c.background.color&&!c.background.image&&(c.background={color:"#fff"}),b=this.createPage(a++,b,c.background),c=new k({canvas:b.find(".sketch"),bgCanvas:b.find(".bg-sketch"),brushImage:null,bgImage:c.outlineImage.img,canvasWidth:this.options.canvasWidth,canvasHeight:this.options.canvasHeight}),this.pages.push(c),b=!1;a=this.book.find(".colors").css("display","block");a.find("a").bind("click",
$.proxy(this.onColorChange,this));return a.find("a.active").trigger("click")};f.prototype.preloadImages=function(){var a,b,c,d,e,h;b=$(this.options.renderTo).find(".colors a");d=0;for(e=b.length;d<e;d++)a=b[d],void 0!==$(a).data("brush")&&(this.imagesToLoad++,c=new Image,c.onload=$.proxy(this.onImageLoaded,this),c.src=$(a).data("brush"));e=this.options.pages;h=[];c=0;for(d=e.length;c<d;c++)b=e[c],this.imagesToLoad++,a=new Image,b.outlineImage.img=a,a.onload=$.proxy(this.onImageLoaded,this),h.push(a.src=
b.outlineImage.path);return h};f.prototype.onImageLoaded=function(){this.imagesToLoad--;if(0>=this.imagesToLoad)return this.createBook()};f.prototype.createPage=function(a,b,c){var d;d=(!0===b?"active":"inactive")+(" js-page-"+a);c=void 0!==c.color?c.color:"transparent";c=void 0!==c.image?" url("+c.image+");":";";a=$('            <div data-num="'+a+'" '+('style="background: '+c+'"')+' class="page animated '+d+'">                <canvas width="'+this.options.canvasWidth+'" height="'+this.options.canvasHeight+
'" class="sketch" ></canvas>                <canvas width="'+this.options.canvasWidth+'" height="'+this.options.canvasHeight+'" class="bg-sketch" ></canvas>            </div>');$(this.options.renderTo).append(a);return a.css({width:this.options.canvasWidth,height:this.options.canvasHeight,marginLeft:b?-(this.options.canvasWidth/2):2*-this.options.canvasWidth,marginTop:-(this.options.canvasHeight/2),left:"50%",top:"50%"})};f.prototype.onColorChange=function(a){var b,c,d,e,h;a.preventDefault();a=$(a.currentTarget);
if(a.hasClass("reset"))return this.pages[this.currPageNum].clear();$(this.options.renderTo).find(".colors a.active").removeClass("active");a.addClass("active");e=this.pages;h=[];c=0;for(d=e.length;c<d;c++)b=e[c],h.push(b.setBrushColor(a));return h};f.prototype.setupPageControls=function(){var a=this;return $(this.options.renderTo).find(".paginator").show().find("a").bind("click",function(b){var c,d,e;b.preventDefault();if(!a.animatingPage&&(a.animatingPage=!0,b=$(b.currentTarget),""!==b.attr("disabled"))){c=
$(a.options.renderTo).find(".page.active");d=b.find("img");a.currPageNum=parseInt(c.data("num"));if(b.hasClass("js-left"))return e=b.next().find("img"),e.attr("src",e.data("img-enabled")),e=$(a.options.renderTo).find(".js-page-"+(a.currPageNum-1)),c.addClass("fadeOutRightBig").removeClass("active"),e.addClass("fadeInLeftBig active").removeClass("inactive").css("marginLeft",-a.options.canvasWidth/2),setTimeout(function(){return a.clearPage(c)},1E3),0===$(a.options.renderTo).find(".js-page-"+(a.currPageNum-
2)).length?(b.attr("disabled",""),d.attr("src",d.data("img-disabled"))):(b.removeAttr("disabled"),d.attr("src",d.data("img-enabled"))),d=$("a.js-right").removeAttr("disabled").find("img"),d.attr("src",d.data("image-enabled")),a.currPageNum--;e=b.prev().find("img");e.attr("src",e.data("img-enabled"));e=$(a.options.renderTo).find(".js-page-"+(a.currPageNum+1));c.addClass("fadeOutLeftBig").removeClass("active");e.addClass("fadeInRightBig active").removeClass("inactive").css("marginLeft",-a.options.canvasWidth/
2);setTimeout(function(){return a.clearPage(c)},1E3);0===$(a.options.renderTo).find(".js-page-"+(a.currPageNum+2)).length&&(b.attr("disabled",""),d.attr("src",d.data("img-disabled")));d=$(a.options.renderTo).find("a.js-left").removeAttr("disabled").find("img");d.attr("src",d.data("image-enabled"));return a.currPageNum++}})};f.prototype.clearPage=function(a){a.removeClass("fadeInRightBig fadeInLeftBig fadeOutLeftBig fadeOutRightBig").css("marginLeft",2*-this.options.canvasWidth);return this.animatingPage=
!1};window.drawingApp=function(a){return new f(a)};var g=function(a){this.renderFunction=!a.brushImage?this.updateCanvasByLine:this.updateCanvasByBrush;this.brush=a.brushImage;this.touchSupported=Modernizr.touch;this.canvas=a.canvas;this.context=this.canvas.get(0).getContext("2d");this.context.strokeStyle="#000000";this.context.lineWidth=3;this.lastMousePoint={x:0,y:0};this.touchSupported?(this.mouseDownEvent="touchstart",this.mouseMoveEvent="touchmove",this.mouseUpEvent="touchend"):(this.mouseDownEvent=
"mousedown",this.mouseMoveEvent="mousemove",this.mouseUpEvent="mouseup");a.bgCanvas&&a.bgImage&&(this.bgCanvas=a.bgCanvas,this.bgContext=this.bgCanvas.get(0).getContext("2d"),this.bgContext.drawImage(a.bgImage,(a.canvasWidth-a.bgImage.width)/2,(a.canvasHeight-a.bgImage.height)/2),this.bgCanvas.bind(this.mouseDownEvent,this.onCanvasMouseDown()))};g.prototype.setBrushColor=function(a){var b;if(a.hasClass("eraser"))this.renderFunction=this.updateCanvasByLine,this.context.lineWidth=30,this.context.globalCompositeOperation=
"destination-out",this.context.strokeStyle="rgba(0,0,0,1)";else return this.context.globalCompositeOperation="source-over",null!==a.data("brush")?(b=new Image,b.src=a.data("brush"),this.renderFunction=this.updateCanvasByBrush,this.brush=b):this.context.strokeStyle=a.css("background-color")};g.prototype.onCanvasMouseDown=function(){var a=this;return function(b){if(!(a.touchSupported&&0!==b.button))return a.mouseMoveHandler=a.onCanvasMouseMove(),a.mouseUpHandler=a.onCanvasMouseUp(),$(document).bind(a.mouseMoveEvent,
a.mouseMoveHandler),$(document).bind(a.mouseUpEvent,a.mouseUpHandler),a.updateMousePosition(b),a.renderFunction(b)}};g.prototype.onCanvasMouseMove=function(){var a=this;return function(b){a.renderFunction(b);b.preventDefault();return!1}};g.prototype.onCanvasMouseUp=function(){var a=this;return function(){$(document).unbind(a.mouseMoveEvent,a.mouseMoveHandler);$(document).unbind(a.mouseUpEvent,a.mouseUpHandler);a.mouseMoveHandler=null;return a.mouseUpHandler=null}};g.prototype.updateMousePosition=
function(a){var b;b=this.touchSupported?a.targetTouches[0]:a;a=this.canvas.offset();this.lastMousePoint.x=b.pageX-a.left;return this.lastMousePoint.y=b.pageY-a.top};g.prototype.updateCanvasByLine=function(a){this.context.beginPath();this.context.moveTo(this.lastMousePoint.x,this.lastMousePoint.y);this.updateMousePosition(a);this.context.lineTo(this.lastMousePoint.x,this.lastMousePoint.y);return this.context.stroke()};g.prototype.updateCanvasByBrush=function(a){var b,c,d,e,h,g,f,j;d=this.brush.width/
2;c=this.brush.height/2;e={x:this.lastMousePoint.x,y:this.lastMousePoint.y};this.updateMousePosition(a);b={x:this.lastMousePoint.x,y:this.lastMousePoint.y};a=parseInt(this.distanceBetween2Points(e,b));b=this.angleBetween2Points(e,b);f=0;for(j=[];f<=a||0===f;)h=e.x+Math.sin(b)*f-d,g=e.y+Math.cos(b)*f-c,this.context.drawImage(this.brush,h,g),j.push(f++);return j};g.prototype.updateMousePosition=function(a){var b;b=this.touchSupported?a.targetTouches[0]:a;a=this.canvas.offset();this.lastMousePoint.x=
b.pageX-a.left;return this.lastMousePoint.y=b.pageY-a.top};g.prototype.clear=function(){var a;a=this.canvas[0];return this.context.clearRect(0,0,a.width,a.height)};g.prototype.distanceBetween2Points=function(a,b){var c,d;c=b.x-a.x;d=b.y-a.y;return Math.sqrt(Math.pow(c,2)+Math.pow(d,2))};g.prototype.angleBetween2Points=function(a,b){return Math.atan2(b.x-a.x,b.y-a.y)};k=g}).call(this);